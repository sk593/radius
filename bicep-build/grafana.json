{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "languageVersion": "2.1-experimental",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_EXPERIMENTAL_WARNING": "This template uses ARM features that are experimental. Experimental features should be enabled for testing purposes only, as there are no guarantees about the quality or stability of these features. Do not enable these settings for any production usage, or your production environment may be subject to breaking.",
    "_EXPERIMENTAL_FEATURES_ENABLED": [
      "Extensibility"
    ],
    "_generator": {
      "name": "bicep",
      "version": "0.26.54.24096",
      "templateHash": "7469985088344456850"
    }
  },
  "parameters": {
    "name": {
      "type": "string",
      "metadata": {
        "description": "Specifies the name of the grafana dashboard."
      }
    },
    "skuName": {
      "type": "string",
      "defaultValue": "Standard",
      "metadata": {
        "description": "Specifies the sku of the grafana dashboard."
      }
    },
    "adminObjectId": {
      "type": "string",
      "metadata": {
        "description": "Specifies the admin object id."
      }
    },
    "location": {
      "type": "string",
      "metadata": {
        "description": "Specifies the location."
      }
    },
    "azureMonitorWorkspaceId": {
      "type": "string",
      "metadata": {
        "description": "Specifies the azure monitor workspace resource id."
      }
    },
    "clusterResourceId": {
      "type": "string",
      "metadata": {
        "description": "Specifies the AKS cluster resource Id."
      }
    },
    "clusterLocation": {
      "type": "string",
      "metadata": {
        "description": "Specifies the AKS cluster resource location."
      }
    },
    "metricLabelsAllowlist": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Specifies comma-separated list of Kubernetes annotation keys that will be used in the resource's labels metric (Example: 'namespaces=[kubernetes.io/team,...],pods=[kubernetes.io/team],...') By default the metric contains only resource name and namespace labels."
      }
    },
    "metricAnnotationsAllowList": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Specifies comma-separated list of Kubernetes annotation keys that will be used in the resource's labels metric (Example: 'namespaces=[kubernetes.io/team,...],pods=[kubernetes.io/team],...') By default the metric contains only resource name and namespace labels."
      }
    },
    "tags": {
      "type": "object",
      "metadata": {
        "description": "Specifies the resource tags."
      }
    }
  },
  "variables": {
    "azureMonitorWorkspaceSubscriptionId": "[split(parameters('azureMonitorWorkspaceId'), '/')[2]]",
    "azureMonitorWorkspaceResourceGroupName": "[split(parameters('azureMonitorWorkspaceId'), '/')[4]]",
    "clusterSubscriptionId": "[split(parameters('clusterResourceId'), '/')[2]]",
    "clusterResourceGroup": "[split(parameters('clusterResourceId'), '/')[4]]",
    "clusterName": "[split(parameters('clusterResourceId'), '/')[8]]",
    "roleDefinitionId": {
      "GrafanaAdmin": {
        "id": "[subscriptionResourceId(variables('azureMonitorWorkspaceSubscriptionId'), 'Microsoft.Authorization/roleDefinitions', '22926164-76b3-42b3-bc55-97df8dab3e41')]"
      },
      "MonitoringReader": {
        "id": "[subscriptionResourceId(variables('azureMonitorWorkspaceSubscriptionId'), 'Microsoft.Authorization/roleDefinitions', '43d0d8ad-25c7-4714-9337-8ba259a9fe05')]"
      },
      "MonitoringDataReader": {
        "id": "[subscriptionResourceId(variables('azureMonitorWorkspaceSubscriptionId'), 'Microsoft.Authorization/roleDefinitions', 'b0d8363b-8ddd-447d-831f-62ca05bff136')]"
      }
    }
  },
  "resources": {
    "grafana": {
      "type": "Microsoft.Dashboard/grafana",
      "apiVersion": "2022-08-01",
      "name": "[parameters('name')]",
      "location": "[parameters('location')]",
      "sku": {
        "name": "[parameters('skuName')]"
      },
      "identity": {
        "type": "SystemAssigned"
      },
      "properties": {
        "zoneRedundancy": "Disabled",
        "publicNetworkAccess": "Enabled",
        "autoGeneratedDomainNameLabelScope": "TenantReuse",
        "grafanaIntegrations": {
          "azureMonitorWorkspaceIntegrations": [
            {
              "azureMonitorWorkspaceResourceId": "[parameters('azureMonitorWorkspaceId')]"
            }
          ]
        }
      },
      "tags": "[parameters('tags')]"
    },
    "adminRoleAssignment": {
      "condition": "[not(empty(parameters('adminObjectId')))]",
      "type": "Microsoft.Authorization/roleAssignments",
      "apiVersion": "2022-04-01",
      "scope": "[format('Microsoft.Dashboard/grafana/{0}', parameters('name'))]",
      "name": "[guid(resourceId('Microsoft.Dashboard/grafana', parameters('name')), variables('roleDefinitionId').GrafanaAdmin.id)]",
      "properties": {
        "roleDefinitionId": "[variables('roleDefinitionId').GrafanaAdmin.id]",
        "principalId": "[parameters('adminObjectId')]"
      },
      "dependsOn": [
        "grafana"
      ]
    },
    "readerRoleAssignment": {
      "type": "Microsoft.Authorization/roleAssignments",
      "apiVersion": "2022-04-01",
      "scope": "[format('Microsoft.Dashboard/grafana/{0}', parameters('name'))]",
      "name": "[guid(resourceId('Microsoft.Dashboard/grafana', parameters('name')), variables('roleDefinitionId').MonitoringReader.id)]",
      "properties": {
        "roleDefinitionId": "[variables('roleDefinitionId').MonitoringReader.id]",
        "principalId": "[reference('grafana', '2022-08-01', 'full').identity.principalId]"
      },
      "dependsOn": [
        "grafana"
      ]
    },
    "grafanaIdenityToAzureMonitor": {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[guid(resourceId('Microsoft.Dashboard/grafana', parameters('name')), variables('roleDefinitionId').MonitoringDataReader.id)]",
      "subscriptionId": "[variables('azureMonitorWorkspaceSubscriptionId')]",
      "resourceGroup": "[variables('azureMonitorWorkspaceResourceGroupName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "roleNameGuid": {
            "value": "[guid(resourceId('Microsoft.Dashboard/grafana', parameters('name')), parameters('adminObjectId'), variables('roleDefinitionId').MonitoringDataReader.id)]"
          },
          "roleDefinitionId": {
            "value": "[variables('roleDefinitionId').MonitoringDataReader.id]"
          },
          "principalId": {
            "value": "[reference('grafana', '2022-08-01', 'full').identity.principalId]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "languageVersion": "2.1-experimental",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_EXPERIMENTAL_WARNING": "This template uses ARM features that are experimental. Experimental features should be enabled for testing purposes only, as there are no guarantees about the quality or stability of these features. Do not enable these settings for any production usage, or your production environment may be subject to breaking.",
            "_EXPERIMENTAL_FEATURES_ENABLED": [
              "Extensibility"
            ],
            "_generator": {
              "name": "bicep",
              "version": "0.26.54.24096",
              "templateHash": "16834292699368530131"
            }
          },
          "parameters": {
            "principalId": {
              "type": "string",
              "metadata": {
                "description": "Specifies the principal id."
              }
            },
            "roleDefinitionId": {
              "type": "string",
              "metadata": {
                "description": "Specifies the role definition id."
              }
            },
            "roleNameGuid": {
              "type": "string",
              "metadata": {
                "description": "A new GUID used to identify the role assignment."
              }
            }
          },
          "resources": {
            "roleAssignmentLocal": {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "name": "[parameters('roleNameGuid')]",
              "properties": {
                "roleDefinitionId": "[parameters('roleDefinitionId')]",
                "principalId": "[parameters('principalId')]"
              }
            }
          }
        }
      },
      "dependsOn": [
        "grafana"
      ]
    },
    "enableMonitorAddon": {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[format('OnboardMetricsOnCluster-{0}', uniqueString(parameters('clusterResourceId')))]",
      "subscriptionId": "[variables('clusterSubscriptionId')]",
      "resourceGroup": "[variables('clusterResourceGroup')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "clusterName": {
            "value": "[variables('clusterName')]"
          },
          "clusterLocation": {
            "value": "[parameters('clusterLocation')]"
          },
          "metricLabelsAllowlist": {
            "value": "[parameters('metricLabelsAllowlist')]"
          },
          "metricAnnotationsAllowList": {
            "value": "[parameters('metricAnnotationsAllowList')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "languageVersion": "2.1-experimental",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_EXPERIMENTAL_WARNING": "This template uses ARM features that are experimental. Experimental features should be enabled for testing purposes only, as there are no guarantees about the quality or stability of these features. Do not enable these settings for any production usage, or your production environment may be subject to breaking.",
            "_EXPERIMENTAL_FEATURES_ENABLED": [
              "Extensibility"
            ],
            "_generator": {
              "name": "bicep",
              "version": "0.26.54.24096",
              "templateHash": "16857824565305167092"
            }
          },
          "parameters": {
            "clusterName": {
              "type": "string",
              "metadata": {
                "description": "Specifies the AKS cluster resource name."
              }
            },
            "clusterLocation": {
              "type": "string",
              "metadata": {
                "description": "Specifies the AKS cluster resource location."
              }
            },
            "metricLabelsAllowlist": {
              "type": "string",
              "metadata": {
                "description": "Specifies comma-separated list of Kubernetes annotation keys that will be used in the resource's labels metric (Example: 'namespaces=[kubernetes.io/team,...],pods=[kubernetes.io/team],...') By default the metric contains only resource name and namespace labels."
              }
            },
            "metricAnnotationsAllowList": {
              "type": "string",
              "metadata": {
                "description": "Specifies comma-separated list of Kubernetes annotation keys that will be used in the resource's labels metric (Example: 'namespaces=[kubernetes.io/team,...],pods=[kubernetes.io/team],...') By default the metric contains only resource name and namespace labels."
              }
            }
          },
          "resources": {
            "enableMonitorAddon": {
              "type": "Microsoft.ContainerService/managedClusters",
              "apiVersion": "2023-05-01",
              "name": "[parameters('clusterName')]",
              "location": "[parameters('clusterLocation')]",
              "properties": {
                "azureMonitorProfile": {
                  "metrics": {
                    "enabled": true,
                    "kubeStateMetrics": {
                      "metricLabelsAllowlist": "[parameters('metricLabelsAllowlist')]",
                      "metricAnnotationsAllowList": "[parameters('metricAnnotationsAllowList')]"
                    }
                  }
                }
              }
            }
          }
        }
      },
      "dependsOn": [
        "grafanaIdenityToAzureMonitor"
      ]
    }
  },
  "outputs": {
    "dashboardFQDN": {
      "type": "string",
      "value": "[reference('grafana').endpoint]"
    }
  }
}