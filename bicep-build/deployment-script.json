{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "languageVersion": "2.1-experimental",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_EXPERIMENTAL_WARNING": "This template uses ARM features that are experimental. Experimental features should be enabled for testing purposes only, as there are no guarantees about the quality or stability of these features. Do not enable these settings for any production usage, or your production environment may be subject to breaking.",
    "_EXPERIMENTAL_FEATURES_ENABLED": [
      "Extensibility"
    ],
    "_generator": {
      "name": "bicep",
      "version": "0.26.54.24096",
      "templateHash": "427589963381207452"
    }
  },
  "parameters": {
    "name": {
      "type": "string",
      "defaultValue": "BashScript",
      "metadata": {
        "description": "Specifies the name of the deployment script uri."
      }
    },
    "clusterName": {
      "type": "string",
      "metadata": {
        "description": "Specifies the name of the AKS cluster."
      }
    },
    "resourceGroupName": {
      "type": "string",
      "defaultValue": "[resourceGroup().name]",
      "metadata": {
        "description": "Specifies the resource group name"
      }
    },
    "subscriptionId": {
      "type": "string",
      "defaultValue": "[subscription().subscriptionId]",
      "metadata": {
        "description": "Specifies the subscription id."
      }
    },
    "tenantId": {
      "type": "string",
      "defaultValue": "[subscription().tenantId]",
      "metadata": {
        "description": "Specifies the tenant id."
      }
    },
    "utcValue": {
      "type": "string",
      "defaultValue": "[utcNow()]",
      "metadata": {
        "description": "Specifies the current datetime"
      }
    },
    "location": {
      "type": "string",
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "Specifies the location."
      }
    },
    "tags": {
      "type": "object",
      "metadata": {
        "description": "Specifies the resource tags."
      }
    }
  },
  "variables": {
    "$fxv#0": "#!/bin/bash\n\n# Cert-manager variables\nCertManagerVersion=\"v1.12.0\"\n\naz aks install-cli --only-show-errors\n\n# Get AKS credentials\naz aks get-credentials \\\n  --admin \\\n  --name $clusterName \\\n  --resource-group $resourceGroupName \\\n  --subscription $subscriptionId \\\n  --only-show-errors\n\necho \"Installing Helm...\"\ncurl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash\n\necho \"Installing cert-manager...\"\nkubectl apply -f https://github.com/cert-manager/cert-manager/releases/download/$CertManagerVersion/cert-manager.yaml\n\necho '{}' >$AZ_SCRIPTS_OUTPUT_PATH",
    "clusterAdminRoleDefinitionId": "[resourceId('Microsoft.Authorization/roleDefinitions', '0ab0b1a8-8aac-4efd-b8c2-3ee1fb270be8')]"
  },
  "resources": {
    "aksCluster": {
      "existing": true,
      "type": "Microsoft.ContainerService/managedClusters",
      "apiVersion": "2023-05-01",
      "name": "[parameters('clusterName')]"
    },
    "managedIdentity": {
      "type": "Microsoft.ManagedIdentity/userAssignedIdentities",
      "apiVersion": "2023-01-31",
      "name": "scriptManagedIdentity",
      "location": "[parameters('location')]",
      "tags": "[parameters('tags')]"
    },
    "clusterAdminContributorRoleAssignment": {
      "type": "Microsoft.Authorization/roleAssignments",
      "apiVersion": "2022-04-01",
      "scope": "[format('Microsoft.ContainerService/managedClusters/{0}', parameters('clusterName'))]",
      "name": "[guid(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', 'scriptManagedIdentity'), resourceId('Microsoft.ContainerService/managedClusters', parameters('clusterName')), variables('clusterAdminRoleDefinitionId'))]",
      "properties": {
        "roleDefinitionId": "[variables('clusterAdminRoleDefinitionId')]",
        "principalId": "[reference('managedIdentity').principalId]",
        "principalType": "ServicePrincipal"
      },
      "dependsOn": [
        "aksCluster",
        "managedIdentity"
      ]
    },
    "deploymentScript": {
      "type": "Microsoft.Resources/deploymentScripts",
      "apiVersion": "2020-10-01",
      "name": "[parameters('name')]",
      "location": "[parameters('location')]",
      "kind": "AzureCLI",
      "identity": {
        "type": "UserAssigned",
        "userAssignedIdentities": {
          "[format('{0}', resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', 'scriptManagedIdentity'))]": {}
        }
      },
      "properties": {
        "forceUpdateTag": "[parameters('utcValue')]",
        "azCliVersion": "2.50.0",
        "timeout": "PT30M",
        "environmentVariables": [
          {
            "name": "clusterName",
            "value": "[parameters('clusterName')]"
          },
          {
            "name": "resourceGroupName",
            "value": "[parameters('resourceGroupName')]"
          },
          {
            "name": "subscriptionId",
            "value": "[parameters('subscriptionId')]"
          },
          {
            "name": "tenantId",
            "value": "[parameters('tenantId')]"
          }
        ],
        "scriptContent": "[variables('$fxv#0')]",
        "cleanupPreference": "OnSuccess",
        "retentionInterval": "P1D"
      },
      "dependsOn": [
        "managedIdentity"
      ]
    },
    "log": {
      "existing": true,
      "type": "Microsoft.Resources/deploymentScripts/logs",
      "apiVersion": "2020-10-01",
      "name": "[format('{0}/{1}', parameters('name'), 'default')]",
      "dependsOn": [
        "deploymentScript"
      ]
    }
  },
  "outputs": {
    "log": {
      "type": "string",
      "value": "[reference('log').log]"
    }
  }
}